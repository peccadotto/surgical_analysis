---
title: "SURGICAL ANALYSIS"
author: "Dr. Andrea PECCATI"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    toc_depth: 3
    thumbnails: false
    lightbox: true
    gallery: false
    collapsed: false # Forza l'espansione dei menu
---

------------------------------------------------------------------------

```{r setup, include = FALSE}
knitr::opts_chunk$set(
	fig.align = "center",
	fig.height = 6,
	fig.width = 8,
	message = FALSE,
	warning = FALSE,
	dpi = 100,
	out.height = "600px",
	out.width = "800px"
)
load("surgical_analysis.RData")
library(kableExtra)
library(tidyverse)

# Create plot theme
  my_plot_theme <- theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 22, hjust = 0.5, margin = margin(t = 10, b = 20)),
      axis.title = element_text(face = "bold", size = 12),
      axis.text  = element_text(face = "bold", size = 12),
      axis.line  = element_line(color = "black", size = 0.5),
      axis.ticks = element_line(color = "black")
    )
```

The following objects were exported in .RData format form the `surgical_analysis.R` file to be imported in this report:

-   the `surgeries_stats` dataframe

-   the `procedures_stats` dataframe

## 1. PROCEDURES

This is the report of the **procedures performed between `r min(surgeries_stats$year)` and `r max(surgeries_stats$year)`**.

### Table

```{r}
surgeries_stats |> 
  select(year, procedures) |>
  mutate(cumulative = cumsum(procedures)) |>
  rename(
    "Year" = year,
    "Procedures" = procedures,
    "Running total" = cumulative
  ) |>
  kbl(align="c")|>
  kable_styling(
    bootstrap_options = "striped", 
    full_width = FALSE,      
    position = "center"
  ) |>
  column_spec(1:3, width = "150px")
```

### Plot

```{r}
  surgeries_plot <- ggplot(
      data = surgeries_stats,
      aes(x = year)
    ) +
    geom_bar(
      aes(y = procedures),
      stat = "identity",
      fill = "lightgrey",
      color = "black",
      alpha = 0.6
    ) +
    geom_text(
      aes(y = procedures, label = procedures),
      vjust = -0.5,
      fontface = "bold",
      size = 5
    ) +
    scale_x_continuous(
      name ="",
      breaks = seq(min(surgeries_stats$year), max(surgeries_stats$year), by = 1)
    ) +
    scale_y_continuous(
      name = "",
      expand = expansion(mult = c(0, 0.05))
    ) +
    labs(
      title = paste0("TOTAL PROCEDURES PER YEAR (", min(surgeries_stats$year), "-", max(surgeries_stats$year), ")")
    ) +
    my_plot_theme
  print(surgeries_plot)
```

------------------------------------------------------------------------

## 2. PROCEDURES AS LEAD SURGEON

This is the report of the **procedures performed as lead surgeon between `r min(surgeries_stats$year)` and `r max(surgeries_stats$year)`**.

The table shows, for each year:

1.  the total amount of performed procedures

2.  the % of procedures performed as lead surgeon relative to the total amount of performed procedures

Data show [**a clear consistently increasing % of procedures performes as lead surgeon, to indicate a constantly increasing surgical autonomy**.]{.underline}

### Table

```{r}
surgeries_stats |> 
  select(year, lead, pct_lead) |>
  mutate(pct_lead = sprintf("%.2f%%", pct_lead)) |>
  mutate(cumulative = cumsum(lead)) |>
  rename(
    "Year" = year,
    "As lead surgeon" = lead,
    "%" = pct_lead,
    "Running total" = cumulative
  ) |>
  kbl(align="c")|>
  kable_styling(
    bootstrap_options = "striped", 
    full_width = FALSE,      
    position = "center"
  ) |>
  column_spec(1:4, width = "150px")
```

### Plot

```{r}
  lead_plot <- ggplot(
    data = surgeries_stats,
    aes(x = year)
  ) +
    geom_bar(
      aes(y = pct_lead),
      stat = "identity",
      fill = "lightgrey",
      color = "black",
      alpha = 0.6
    ) +
    geom_text(
      aes(y = pct_lead, label = paste0(round(pct_lead, 0), "%")),
      vjust = -0.5,
      fontface = "bold",
      size = 5
    ) +
    scale_x_continuous(
      name ="",
      breaks = seq(min(surgeries_stats$year), max(surgeries_stats$year), by = 1)
    ) +
    scale_y_continuous(
      name = "",
      expand = expansion(mult = c(0, 0.05))
    ) +
    labs(
      title = paste0("% AS LEAD SURGEON PER YEAR (", min(surgeries_stats$year), "-", max(surgeries_stats$year), ")")
    ) +
    my_plot_theme
  print(lead_plot)
```

------------------------------------------------------------------------

## 3. TOP 15 PROCEDURES

This is the report of the **top 15 procedures, performed between `r min(surgeries_stats$year)` and `r max(surgeries_stats$year)`**.

Short and long description of ICD-9 procedures were taken from the [CMS.gov website](https://www.cms.gov/medicare/coding-billing/icd-10-codes/icd-9-cm-diagnosis-procedure-codes-abbreviated-and-full-code-titles).

### Table

```{r}
procedures_stats |>
  select(procedure, procedures, short_descr)|>
  rename(
    "ICD-9 Code" = procedure,
    "Procedures" = procedures,
    "ICD-9 short description" = short_descr
  ) |>
  kbl(align="ccl")|>
  kable_styling(
    bootstrap_options = "striped", 
    full_width = FALSE,      
    position = "center"
  ) |>
  column_spec(1, width = "150px") |>
  column_spec(2, width = "150px") |>
  column_spec(3, width = "300px")
```

### Plot

```{r}
  procedures_plot <- ggplot(
    data = procedures_stats,
    aes(x = reorder(short_descr, procedures), y = procedures)
  ) +
    geom_col(
      fill = "lightgrey",
      color = "black"
    ) +
    geom_text(
      aes(label = procedure),
      y = 0,
      hjust = -0.1,
      fontface = "bold",
      size = 4
    ) +
    geom_text(
      aes(label = procedures),
      hjust = -0.5, 
      fontface = "bold",
      size = 5
      ) +
    scale_x_discrete(
      name = ""
    ) +
    scale_y_continuous(
      name="",
      expand = expansion(mult = c(0, 0.05))
    ) +
    labs(
      title = paste("TOP",length(procedures_stats$procedure),"ICD-9 PROCEDURES"),
    ) +
    coord_flip() +
    my_plot_theme
  print(procedures_plot)
```
